<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PVSS Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
    margin:0;
    font-family: 'Segoe UI', sans-serif;
    background:#f4f7fb;
    color:#1e293b;
}
.container{
    max-width:500px;
    margin:auto;
    padding:20px;
}
.header{text-align:center;}
.logo{width:90px;margin-bottom:10px;}
.badge{
    display:inline-block;
    padding:5px 12px;
    border-radius:20px;
    background:#e6f4ea;
    color:#0f5132;
    font-size:12px;
    margin-bottom:20px;
}
.hero{
    background:linear-gradient(135deg,#1fa463,#0f7a4d);
    color:white;
    padding:25px;
    border-radius:20px;
    margin-bottom:20px;
}
.hero h2{margin:0;font-size:14px;}
.hero p{margin:5px 0 0;font-size:28px;font-weight:bold;}
.grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:15px;
    margin-bottom:20px;
}
.card{
    background:white;
    padding:15px;
    border-radius:15px;
    box-shadow:0 5px 15px rgba(0,0,0,0.05);
}
.card h3{margin:0;font-size:12px;color:#64748b;}
.card p{margin:5px 0 0;font-size:18px;font-weight:bold;}
canvas{margin-top:20px;}
.section-title{margin-top:30px;font-weight:bold;}
select{
    width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid #cbd5e1;
    margin:10px 0;
}
table{width:100%;font-size:12px;border-collapse:collapse;}
th,td{padding:6px;text-align:left;}
th{background:#e2e8f0;}
tr:nth-child(even){background:#f1f5f9;}
footer{text-align:center;font-size:12px;margin-top:30px;color:#64748b;}
</style>
</head>

<body>
<div class="container">

<div class="header">
    <img src="logo.png" class="logo">
    <h2>PV SAVINGS DASHBOARD</h2>
    <div class="badge">Since August 2021</div>
</div>

<div class="hero">
    <h2>Total Savings</h2>
    <p id="totalSavings">Loading...</p>
</div>

<div class="grid">
    <div class="card">
        <h3>Emergency Fund</h3>
        <p id="emergencyFund"></p>
    </div>
    <div class="card">
        <h3>Actual Balance</h3>
        <p id="actualBalance"></p>
    </div>
    <div class="card">
        <h3>Loan Outstanding</h3>
        <p id="loanOutstanding"></p>
    </div>
    <div class="card">
        <h3>Active Loans</h3>
        <p id="activeLoans"></p>
    </div>
</div>

<div class="card">
    <h3>Active Members</h3>
    <p id="activeMembers"></p>
</div>

<canvas id="donutChart" height="200"></canvas>

<div class="section-title">Personal Account Statement</div>
<select id="memberSelect"></select>

<div class="grid">
    <div class="card">
        <h3>Saving</h3>
        <p id="memberSaving"></p>
    </div>
    <div class="card">
        <h3>Loan</h3>
        <p id="memberLoan"></p>
    </div>
</div>

<table>
<thead>
<tr>
<th>Date</th>
<th>Savings</th>
<th>Emergency</th>
<th>Repayment</th>
<th>Loan</th>
</tr>
</thead>
<tbody id="transactionTable"></tbody>
</table>

<footer>
Puthan Veettil Savings Scheme – Trust Since 2021
</footer>

</div>

<script>

const dashboardCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQuujA91p43H11szNBzyyJXfYC1edcaPLuOvf_nI_5BskTEI45qFYj3qqpJOn85q0CGmkO75fxnnm2l/pub?gid=1860462&single=true&output=csv";
const ledgerCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQuujA91p43H11szNBzyyJXfYC1edcaPLuOvf_nI_5BskTEI45qFYj3qqpJOn85q0CGmkO75fxnnm2l/pub?gid=0&single=true&output=csv";

function cleanNumber(value){
    return parseFloat(value.replace(/[^0-9.]/g,'')) || 0;
}

/* DASHBOARD DATA */
Papa.parse(dashboardCSV,{
    download:true,
    complete:function(results){

        const rows = results.data;

        function getCell(r,c){
            return rows[r-1][c-1] || "";
        }

        const totalSavings = getCell(5,3);
        const emergency = getCell(9,3);
        const balance = getCell(9,1);
        const activeMembers = getCell(5,1);
        const loan = getCell(7,3);
        const activeLoans = getCell(5,5);

        document.getElementById("totalSavings").innerText = totalSavings;
        document.getElementById("emergencyFund").innerText = emergency;
        document.getElementById("actualBalance").innerText = balance;
        document.getElementById("loanOutstanding").innerText = loan;
        document.getElementById("activeLoans").innerText = activeLoans;
        document.getElementById("activeMembers").innerText = activeMembers;

        new Chart(document.getElementById("donutChart"),{
            type:"doughnut",
            data:{
                labels:["Savings","Loan"],
                datasets:[{
                    data:[cleanNumber(totalSavings),cleanNumber(loan)],
                    backgroundColor:["#16a34a","#dc2626"]
                }]
            }
        });

    }
});

/* LEDGER DATA */
Papa.parse(ledgerCSV,{
    download:true,
    complete:function(results){

        const rows = results.data;
        const select=document.getElementById("memberSelect");
        const members=[...new Set(rows.slice(1).map(r=>r[1]))];

        members.forEach(m=>{
            if(m){
                const opt=document.createElement("option");
                opt.value=m;
                opt.text=m;
                select.add(opt);
            }
        });

        select.onchange=function(){
    const name=this.value;
    const data=rows.filter(r=>r[1]===name);

    let saving = 0;
    let loanTaken = 0;
    let repayment = 0;
    let table="";

    data.forEach(r=>{
        saving += cleanNumber(r[2] || "0");      // Savings
repayment += cleanNumber(r[4] || "0");   // Repayment column
loanTaken += cleanNumber(r[6] || "0");   // Loan given

        table += `<tr>
    <td>${r[0] || ""}</td>
    <td>${r[2] ? cleanNumber(r[2]).toLocaleString() : ""}</td>
<td>${r[3] ? cleanNumber(r[3]).toLocaleString() : ""}</td>
<td>${r[4] ? cleanNumber(r[4]).toLocaleString() : ""}</td>
<td>${r[6] ? cleanNumber(r[6]).toLocaleString() : ""}</td>
</tr>`;
    });

    document.getElementById("memberSaving").innerText="₹"+saving.toLocaleString();
    let outstanding = loanTaken - repayment;

document.getElementById("memberLoan").innerText =
    "₹" + outstanding.toLocaleString();
    document.getElementById("transactionTable").innerHTML=table;
};

    }
});

</script>

</body>

</html>

